# Energy Efficiency Flink Experiments

## Cloudlab Node Setup
### Assume 4 nodes with IP addresses 10.10.1.1, 10.10.1.2, 10.10.1.3, 10.10.1.4
```
10.10.1.1 -> JobManager
10.10.1.2 -> Source
10.10.1.3 -> Mapper
10.10.1.4 -> Sink
```
### Use one of the following node types: [c6220, c220g1, c220g2, c220g5]
![Example cloudlab node config](https://github.com/EEStrmCmptng/eeflink/blob/master/images/cloudlabnodes.png)

### Flink experiment setup:
![Example flink setup](https://github.com/EEStrmCmptng/eeflink/blob/master/images/flinksetup.png)


### Setup node: 5 minutes - Run on all four nodes
```
./prep-node.sh
```

### Build and install Flink: 15 minutes - Run on all four nodes
```
cd ~/eeflink
git clone git@github.com:EEStrmCmptng/flink-simplified.git
cd flink-simplified/scripts
./makeflink.sh
```

### Build and install benchmarks: 3 mins - Run on all four nodes
```
cd ~/eeflink
git clone git@github.com:EEStrmCmptng/flink-benchmarks.git
cd flink-benchmarks
mvn clean package
```

## Sample experimental run, run on JobManage node only
```
This generates 200K records-per-second for 600 seconds or 10 minutes,
with 16 source, 16 mapper, and 16 sink tasks with DVFS policy
ondemand and running query1
```
```
cd ~/eeflink
MCFG="16;16;16" MQUERY="query1" FLINK_RATE="200000_600000" MPOLICY="ondemand" ./run_query1.sh dynamic
```

## Correct experiment output
```
numRecordsOutPerSecond_avg should match the benchmark
generating 200K records per second as we want
to minimize backpressure
```

### file summary.csv should be generated under logs/
```
~/eeflink$ cat logs/query1_cores16_frate200000_180000_fratetype_static_fbuff-1_itr1_ondemanddvfs1_source16_mapper16_sink16_repeat0/summary.csv
,name,numRecordsInPerSecond_avg,numRecordsInPerSecond_std,numRecordsOutPerSecond_avg,numRecordsOutPerSecond_std,busyTimeMsPerSecond_avg,busyTimeMsPerSecond_std,backPressuredTimeMsPerSecond_avg,backPressuredTimeMsPerSecond_std,busyTime_%,backPressuredTime_%
5,Operator_Latency Sink_0,200019.29444444444,3.692004206621125,0.0,0.0,112.16666666666667,3.1841621957571333,0.0,0.0,11.216666666666667,0.0
2,Operator_Latency Sink_1,200018.75277777776,6.784127831350415,0.0,0.0,121.83333333333333,4.597704741377907,0.0,0.0,12.183333333333334,0.0
21,Operator_Latency Sink_10,200019.40000000002,6.0153815186420445,0.0,0.0,114.0,4.898979485566356,0.0,0.0,11.4,0.0
36,Operator_Latency Sink_11,200019.57222222222,5.948775680654383,0.0,0.0,108.66666666666667,5.08811250749125,0.0,0.0,10.866666666666667,0.0
38,Operator_Latency Sink_12,200020.9305555556,5.698013109415637,0.0,0.0,112.16666666666667,4.13991411612474,0.0,0.0,11.216666666666667,0.0
42,Operator_Latency Sink_13,200018.3111111111,6.187058376812065,0.0,0.0,120.83333333333333,3.0230595245361758,0.0,0.0,12.083333333333334,0.0
14,Operator_Latency Sink_14,200021.41111111114,5.963831314738878,0.0,0.0,110.83333333333333,5.273097339852125,0.0,0.0,11.083333333333332,0.0
8,Operator_Latency Sink_15,200018.61388888888,6.977234254305011,0.0,0.0,113.5,6.677075208003377,0.0,0.0,11.35,0.0
28,Operator_Latency Sink_2,200018.34722222225,7.370533278021649,0.0,0.0,120.83333333333333,2.034425935955617,0.0,0.0,12.083333333333334,0.0
30,Operator_Latency Sink_3,200021.26944444445,6.78513091570016,0.0,0.0,112.33333333333333,4.4969125210773475,0.0,0.0,11.233333333333333,0.0
16,Operator_Latency Sink_4,200017.64444444445,8.520729986694434,0.0,0.0,115.0,2.309401076758503,0.0,0.0,11.5,0.0
25,Operator_Latency Sink_5,200020.89444444445,5.7631626048450935,0.0,0.0,106.66666666666667,4.818944098266987,0.0,0.0,10.666666666666668,0.0
45,Operator_Latency Sink_6,200017.54722222223,8.353500135047959,0.0,0.0,110.33333333333333,2.494438257849294,0.0,0.0,11.033333333333333,0.0
3,Operator_Latency Sink_7,200019.04722222223,7.2457102038414245,0.0,0.0,106.0,5.41602560309064,0.0,0.0,10.6,0.0
20,Operator_Latency Sink_8,200020.625,7.593678840547926,0.0,0.0,108.83333333333333,3.4840908267278117,0.0,0.0,10.883333333333333,0.0
10,Operator_Latency Sink_9,200017.64444444445,8.520729986694434,0.0,0.0,123.0,4.898979485566356,0.0,0.0,12.3,0.0
35,Operator_Mapper_0,200013.02777777778,1.9716900690476502,200013.26111111112,1.946308630187309,480.1666666666667,9.06305074954835,0.0,0.0,48.016666666666666,0.0
4,Operator_Mapper_1,200013.07499999998,2.135193416510094,200013.04166666666,2.1037389554299244,498.0,5.744562646538029,0.0,0.0,49.8,0.0
46,Operator_Mapper_10,200013.16666666666,0.8145664604690745,200013.0,0.7277565730576437,508.1666666666667,4.487637339278753,0.0,0.0,50.81666666666666,0.0
0,Operator_Mapper_11,200012.44166666665,0.8448509620947867,200012.5638888889,0.9169906834746009,508.1666666666667,9.581521567869874,0.0,0.0,50.81666666666666,0.0
32,Operator_Mapper_12,200012.55000000002,1.0604855631386203,200012.38055555557,1.0229051160956866,494.6666666666667,8.844332774281066,0.0,0.0,49.46666666666667,0.0
47,Operator_Mapper_13,200012.75555555557,0.7605837589120732,200012.80000000002,0.9133779388940501,506.0,4.281744192888376,0.0,0.0,50.6,0.0
11,Operator_Mapper_14,200012.00833333333,0.5314855142445997,200012.09444444443,0.6507592906107821,524.1666666666666,22.9377176041752,0.0,0.0,52.416666666666664,0.0
41,Operator_Mapper_15,200013.2722222222,1.1395526520991046,200013.375,1.1729493532063664,536.6666666666666,19.310331143946986,0.0,0.0,53.666666666666664,0.0
39,Operator_Mapper_2,200013.41666666666,0.8189311009809638,200013.5861111111,0.6983722255654485,510.6666666666667,5.676462121975467,0.0,0.0,51.06666666666667,0.0
24,Operator_Mapper_3,200012.96666666667,1.283838284498663,200012.67222222223,1.1311935137004816,515.8333333333334,1.2133516482134197,0.0,0.0,51.583333333333336,0.0
23,Operator_Mapper_4,200013.54722222223,1.3470618461216737,200013.40833333333,1.295781974691077,511.3333333333333,4.2295258468165065,0.0,0.0,51.13333333333333,0.0
33,Operator_Mapper_5,200012.64444444445,1.4400252912676057,200012.525,1.2941016475078222,515.3333333333334,4.109609335312651,0.0,0.0,51.533333333333346,0.0
27,Operator_Mapper_6,200013.16111111114,1.2214012394175136,200013.1972222222,1.2478283605148393,521.3333333333334,2.054804667656325,0.0,0.0,52.13333333333334,0.0
6,Operator_Mapper_7,200012.92777777778,1.1637529753586837,200012.83888888892,1.1801862167367796,505.5,2.6299556396765835,0.0,0.0,50.55,0.0
19,Operator_Mapper_8,200013.43888888892,1.2354586292889922,200013.3138888889,1.1992056269919118,507.0,4.618802153517006,0.0,0.0,50.7,0.0
13,Operator_Mapper_9,200013.39444444445,0.8379685901206184,200013.30277777778,0.8607929519795493,521.8333333333334,6.3879226322456,0.0,0.0,52.18333333333334,0.0
29,Operator_Source: Bids Source_0,0.0,0.0,200010.83055555553,0.46531716252210775,0.0,0.0,0.0,0.0,0.0,0.0
9,Operator_Source: Bids Source_1,0.0,0.0,200010.44722222222,0.5557291395453574,0.0,0.0,0.0,0.0,0.0,0.0
43,Operator_Source: Bids Source_10,0.0,0.0,200010.60555555555,0.4787780227416523,0.0,0.0,0.0,0.0,0.0,0.0
12,Operator_Source: Bids Source_11,0.0,0.0,200010.62222222224,0.4579206896619783,0.0,0.0,0.0,0.0,0.0,0.0
17,Operator_Source: Bids Source_12,0.0,0.0,200010.59722222222,0.44466140538171534,0.0,0.0,0.0,0.0,0.0,0.0
44,Operator_Source: Bids Source_13,0.0,0.0,200015.08333333334,9.845957057107972,0.0,0.0,0.0,0.0,0.0,0.0
1,Operator_Source: Bids Source_14,0.0,0.0,200010.63055555554,0.4616212038046246,0.0,0.0,0.0,0.0,0.0,0.0
22,Operator_Source: Bids Source_15,0.0,0.0,200011.25833333333,1.480263677716199,0.0,0.0,0.0,0.0,0.0,0.0
40,Operator_Source: Bids Source_2,0.0,0.0,200010.6083333333,0.4712817432077859,0.0,0.0,0.0,0.0,0.0,0.0
26,Operator_Source: Bids Source_3,0.0,0.0,200010.525,0.593073444955883,0.0,0.0,0.0,0.0,0.0,0.0
31,Operator_Source: Bids Source_4,0.0,0.0,200010.56944444447,0.49379639178922685,0.0,0.0,0.0,0.0,0.0,0.0
15,Operator_Source: Bids Source_5,0.0,0.0,200010.66666666666,0.45061686114856375,0.0,0.0,0.0,0.0,0.0,0.0
37,Operator_Source: Bids Source_6,0.0,0.0,200010.65833333335,0.4013576496859599,0.0,0.0,0.0,0.0,0.0,0.0
7,Operator_Source: Bids Source_7,0.0,0.0,200010.59166666667,0.5225250304098812,0.0,0.0,0.0,0.0,0.0,0.0
34,Operator_Source: Bids Source_8,0.0,0.0,200010.525,0.5624639906119688,0.0,0.0,0.0,0.0,0.0,0.0
18,Operator_Source: Bids Source_9,0.0,0.0,200010.56944444447,0.44798072324039173,0.0,0.0,0.0,0.0,0.0,0.0
```

